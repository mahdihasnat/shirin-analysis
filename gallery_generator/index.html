<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extracted Frames Gallery</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        /* Filter Styles */
        .controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-label {
            font-weight: bold;
            color: #555;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-wrapper input {
            cursor: pointer;
        }

        .status-bar {
            text-align: center;
            margin-bottom: 15px;
            color: #666;
            font-size: 0.9em;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            padding: 10px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .gallery-item {
            background-color: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.2s;
        }

        .gallery-item:hover {
            transform: translateY(-5px);
        }

        .gallery-item img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 4px;
            background-color: #eee;
            aspect-ratio: 16/9;
            object-fit: cover;
        }

        .gallery-item p {
            margin: 8px 0 0;
            font-size: 0.85em;
            color: #666;
            word-break: break-all;
        }

        #loading {
            text-align: center;
            font-size: 1.2em;
            color: #666;
            margin-top: 50px;
        }
    </style>
</head>

<body>
    <h1>Extracted Frames Gallery</h1>

    <div id="controls" class="controls" style="display:none;">
        <span class="filter-label">Filters:</span>
        <div id="filter-container" class="filter-group">
            <!-- Checkboxes will be injected here -->
        </div>
    </div>

    <div id="status" class="status-bar"></div>
    <div id="loading">Loading configuration...</div>
    <div class="gallery" id="gallery"></div>

    <script>
        // State
        let config = { basePath: '', filters: [] };
        let loadedSets = {}; // Cache for loaded JSON data: { filterId: Set<filename> }
        let availableFilters = [];

        const gallery = document.getElementById('gallery');
        const loading = document.getElementById('loading');
        const controls = document.getElementById('controls');
        const filterContainer = document.getElementById('filter-container');
        const status = document.getElementById('status');

        async function init() {
            try {
                // 1. Load filters configuration
                const response = await fetch('filters.json');
                if (!response.ok) throw new Error("Could not load filters.json");
                availableFilters = await response.json();

                // 2. Build UI
                buildFilterUI();

                // 3. Load default filters
                loading.innerText = "Loading frame data...";

                // Find defaults or select first one if no default specified
                // Usually "all" is a good start
                const defaultFilters = availableFilters.filter(f => f.default);
                if (defaultFilters.length === 0 && availableFilters.length > 0) {
                    defaultFilters.push(availableFilters[0]);
                    // Mark input as checked
                    const input = document.getElementById(`filter-${availableFilters[0].id}`);
                    if (input) input.checked = true;
                }

                // Trigger initial load
                await applyFilters();

                controls.style.display = 'flex';
                loading.style.display = 'none';

            } catch (e) {
                loading.innerText = 'Error initializing: ' + e.message;
                console.error(e);
            }
        }

        function buildFilterUI() {
            filterContainer.innerHTML = '';
            availableFilters.forEach(filter => {
                const label = document.createElement('label');
                label.className = 'checkbox-wrapper';

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `filter-${filter.id}`;
                input.value = filter.id;
                if (filter.default) input.checked = true;

                input.onchange = applyFilters;

                label.appendChild(input);
                label.appendChild(document.createTextNode(filter.name));
                filterContainer.appendChild(label);
            });
        }

        // Helper: Expand items (ranges + strings) into a Set of filenames
        function expandItemsToSet(items) {
            const set = new Set();
            for (const item of items) {
                if (typeof item === 'string') {
                    set.add(item);
                } else if (item.type === 'range') {
                    for (let i = item.start; i <= item.end; i++) {
                        const numStr = i.toString().padStart(item.digits, '0');
                        set.add(`${item.prefix}${numStr}${item.extension}`);
                    }
                }
            }
            return set;
        }

        async function loadFilterData(filter) {
            if (loadedSets[filter.id]) return loadedSets[filter.id];

            try {
                const res = await fetch(filter.file);
                const data = await res.json();

                // Store base path from the first loaded file (assuming all share same base)
                if (!config.basePath && data.basePath) {
                    config.basePath = data.basePath;
                }

                const set = expandItemsToSet(data.items);
                loadedSets[filter.id] = set;
                return set;
            } catch (e) {
                console.error(`Failed to load ${filter.file}`, e);
                return new Set();
            }
        }

        async function applyFilters() {
            // Get selected filters
            const selectedIds = Array.from(filterContainer.querySelectorAll('input:checked')).map(i => i.value);

            if (selectedIds.length === 0) {
                gallery.innerHTML = '';
                status.innerText = 'No filters selected. Select a filter to view frames.';
                return;
            }

            status.innerText = 'Updating gallery...';

            // Load data for all selected filters
            // We need to wait for all fetches to complete
            const selectedFilters = availableFilters.filter(f => selectedIds.includes(f.id));
            await Promise.all(selectedFilters.map(f => loadFilterData(f)));

            // Compute Intersection
            // Start with the first set
            let resultIds = Array.from(loadedSets[selectedIds[0]]);

            // Intersect with remaining sets
            for (let i = 1; i < selectedIds.length; i++) {
                const set = loadedSets[selectedIds[i]];
                resultIds = resultIds.filter(id => set.has(id));
            }

            // Render
            renderGallery(resultIds);
        }

        function renderGallery(filenames) {
            gallery.innerHTML = '';
            status.innerText = `Showing ${filenames.length} frames`;

            const fragment = document.createDocumentFragment();

            // Sort filenames natural order
            filenames.sort((a, b) => {
                return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
            });

            // Limit rendering for performance if massive (virtualization would be better but this is simple)
            // Let's rely on browser lazy loading for images, but rendering 10k divs might be heavy.
            // For now, render all.

            filenames.forEach(filename => {
                const div = document.createElement('div');
                div.className = 'gallery-item';
                const url = `${config.basePath}/${filename}`;

                div.innerHTML = `
                    <img src="${url}" alt="${filename}" loading="lazy">
                    <p>${filename}</p>
                `;
                fragment.appendChild(div);
            });

            gallery.appendChild(fragment);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>